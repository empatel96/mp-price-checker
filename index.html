<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MyProtein Price Checker</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f9;
        margin: 0;
        padding: 20px;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        background-color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
      }
      h1 {
        text-align: center;
        color: #333;
      }
      label {
        font-size: 16px;
        display: block;
        margin-bottom: 8px;
      }
      input[type='text'] {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        margin-bottom: 20px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }
      button {
        width: 100%;
        padding: 10px;
        background-color: #007bff;
        color: white;
        font-size: 18px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      .result {
        margin-top: 20px;
        padding: 10px;
        background-color: #e8f5e9;
        border-radius: 4px;
        border: 1px solid #c8e6c9;
      }
      .error {
        color: red;
        background-color: #ffebee;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #f44336;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Check MyProtein Prices</h1>
      <input type="text" id="sku" placeholder="Enter SKU" />
      <button id="checkPriceButton">Check Price</button>

      <div id="errorMessage"></div>
      <div id="result"></div>
    </div>
    <script>
      document
        .getElementById('checkPriceButton')
        .addEventListener('click', function () {
          const sku = document.getElementById('sku').value.trim();

          // Check if SKU is entered
          if (!sku) {
            alert('Please enter a valid SKU.');
            return;
          }

          const requestBody = {
            operationName: 'ProductVariants',
            variables: {
              sku: sku,
              currency: 'GBP',
              shippingDestination: 'GB',
              buyNowPayLater: false,
              enableWishlist: false,
              hasSubscriptions: true,
            },
          };

          const headers = {
            'Content-Type': 'application/json',
            Accept: '*/*',
          };

          // Clear previous results and error messages
          document.getElementById('result').innerHTML = '';
          document.getElementById('errorMessage').style.display = 'none';

          // Send the request to MyProtein API
          axios
            .get(
              'https://ycm8zcsfi7.execute-api.eu-west-2.amazonaws.com/get-mp-price?sku=' +
                sku,
              // requestBody,
              { headers }
            )
            .then((response) => {
              const data = response.data.data;

              // let productsWithPricePerKg = [];

              // // Loop through each variant to calculate price per kg and store the data
              // variants.forEach((variant) => {
              //   const title = variant.title;
              //   const priceAmount = parseFloat(variant.price.price.amount);
              //   const weightMatch = variant.choices.find(
              //     (choice) => choice.optionKey === 'Amount'
              //   );

              //   let weight = 0;
              //   let pricePerServing = 0;

              //   // If the Amount is in servings, calculate cost per serving
              //   if (weightMatch) {
              //     const amountKey = weightMatch.key.toLowerCase();

              //     if (
              //       amountKey.includes('servings') ||
              //       amountKey.includes('tablets')
              //     ) {
              //       const servings = parseInt(amountKey.replace(/\D/g, ''), 10);
              //       pricePerServing = priceAmount / servings;
              //       productsWithPricePerKg.push({
              //         title: title,
              //         total: priceAmount,
              //         servings: servings,
              //         sku: variant.sku,
              //         pricePerServing: pricePerServing.toFixed(2),
              //         inStock: variant.inStock ? 'Yes' : 'No',
              //         pricePerKg: null,
              //       });
              //     } else if (
              //       amountKey.includes('kg') ||
              //       amountKey.includes('g')
              //     ) {
              //       weight = parseFloat(amountKey.replace(/[^\d\.]/g, '')) || 0;
              //       if (!amountKey.includes('kg')) weight = weight / 1000; // Convert grams to kg
              //     }
              //   }

              //   // Calculate price per kg for weight-based variants
              //   if (weight > 0) {
              //     const pricePerKg = priceAmount / weight;
              //     productsWithPricePerKg.push({
              //       title: title,
              //       total: priceAmount,
              //       weight: weight,
              //       sku: variant.sku,
              //       pricePerKg: pricePerKg.toFixed(2),
              //       inStock: variant.inStock ? 'Yes' : 'No',
              //       pricePerServing: null,
              //     });
              //   }
              // });

              // // Now, filter the best variants by price per kg or per serving
              // const bestVariants = productsWithPricePerKg
              //   .map((variant) => {
              //     const price = parseFloat(
              //       variant.pricePerKg || variant.pricePerServing
              //     );
              //     return { ...variant, pricePerUnit: price };
              //   })
              //   .sort((a, b) => a.pricePerUnit - b.pricePerUnit); // Sort by the lowest price

              // const bestPrice = bestVariants[0].pricePerUnit; // Best price per kg or per serving
              // const filteredBestVariants = bestVariants.filter(
              //   (v) => v.pricePerUnit === bestPrice
              // );

              // Show the result
              let resultHTML = '<h2>Best Products with Lowest Price:</h2>';
              data.forEach((variant) => {
                resultHTML += `
              <p><strong>${variant.title}</strong> (SKU: ${variant.sku})</p>
              <p>Price: £${variant.total}</p>
              <p>Price per unit: £${variant.pricePerUnit}</p>
              <p>Stock: ${variant.inStock}</p>
              <hr>
            `;
              });
              document.getElementById('result').innerHTML = resultHTML;
            })
            .catch((error) => {
              console.error('Error:', error);
              document.getElementById('errorMessage').innerText =
                'Error fetching data. Please try again.';
              document.getElementById('errorMessage').style.display = 'block';
            });
        });
    </script>
  </body>
</html>
